# ğŸº Projekt Cerberus Phoenix v2.0 - CI/CD Pipeline
name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ğŸ§ª Testing
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust: [stable, beta]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy
        
    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: ğŸ§ª Run tests - HFT Ninja
      run: |
        cd services/hft-ninja
        cargo test --verbose
        
    - name: ğŸ§ª Run tests - Cerebro BFF
      run: |
        cd services/cerebro-bff
        cargo test --verbose

  # ğŸ” Code Quality
  quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
        
    - name: ğŸ¨ Check formatting
      run: |
        cd services/hft-ninja && cargo fmt -- --check
        cd services/cerebro-bff && cargo fmt -- --check
        
    - name: ğŸ” Clippy linting
      run: |
        cd services/hft-ninja && cargo clippy -- -D warnings
        cd services/cerebro-bff && cargo clippy -- -D warnings

  # ğŸ” Security
  security:
    name: ğŸ” Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: ğŸ” Install cargo-audit
      run: cargo install cargo-audit
      
    - name: ğŸ” Security audit - HFT Ninja
      run: |
        cd services/hft-ninja
        cargo audit
        
    - name: ğŸ” Security audit - Cerebro BFF
      run: |
        cd services/cerebro-bff
        cargo audit

  # ğŸ—ï¸ Build
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [test, quality, security]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: ğŸ—ï¸ Build HFT Ninja
      run: |
        cd services/hft-ninja
        cargo build --release
        
    - name: ğŸ—ï¸ Build Cerebro BFF
      run: |
        cd services/cerebro-bff
        cargo build --release

  # ğŸ³ Docker Build
  docker:
    name: ğŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ”‘ Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ—ï¸ Build and push Docker images
      run: |
        cd infrastructure
        docker-compose build
        docker-compose push

  # ğŸ“Š Performance Tests
  performance:
    name: ğŸ“Š Performance Tests
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: ğŸ“Š Run benchmarks
      run: |
        cd services/hft-ninja
        cargo bench
        cd ../cerebro-bff
        cargo bench

  # ğŸš€ Deploy to Staging
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [docker, performance]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to staging
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        # TODO: Implement staging deployment

  # ğŸŒŸ Deploy to Production
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [docker, performance]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŒŸ Deploy to production
      run: |
        echo "ğŸŒŸ Deploying to production environment..."
        # TODO: Implement production deployment
